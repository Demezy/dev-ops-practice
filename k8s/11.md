# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Creating and Verifying Secrets

1. Created secret using kubectl:
```bash
kubectl create secret generic app-secret --from-literal=MY_SECRET=SuperSecretPassword123!
```

2. Verifying the secret:
```bash
kubectl get secret app-secret -o jsonpath='{.data.MY_SECRET}' | base64 --decode
SuperSecretPassword123!
```

3. After deploying with Helm:
```bash
kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
app-python-5f898f5f4c-2gpnd       1/1     Running   0          5m

kubectl exec app-python-5f898f5f4c-2gpnd -- printenv | grep MY_SECRET
MY_SECRET=SuperSecretPassword123!
```

## Task 2: Vault Secret Management System

1. Installed Vault using Helm:
```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm install vault hashicorp/vault --set "server.dev.enabled=true"
```

2. Set up secret in Vault:
```bash
kubectl exec -it vault-0 -- /bin/sh
vault secrets enable -path=secret kv-v2
vault kv put secret/app-python/config password="db-secret-password"
```

3. Configured Kubernetes authentication:
```bash
vault auth enable kubernetes
vault write auth/kubernetes/config \
    kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
    token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
    kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
    issuer="https://kubernetes.default.svc.cluster.local"
```

4. Created Vault policy and role:
```bash
vault policy write app-python - <<EOF
path "secret/data/app-python/*" {
  capabilities = ["read"]
}
EOF

vault write auth/kubernetes/role/app-python \
    bound_service_account_names=app-python \
    bound_service_account_namespaces=default \
    policies=app-python \
    ttl=24h
```

5. Verified secrets injection:
```bash
kubectl exec -it app-python-5f898f5f4c-2gpnd -- cat /vault/secrets/config
export DB_PASSWORD="db-secret-password"
```

## Bonus Task: Resource Management

Added resource limits and requests in values.yaml:
```yaml
resources:
  limits:
    cpu: 100m
    memory: 128Mi
  requests:
    cpu: 50m
    memory: 64Mi
```

Added environment variables using named templates in _helpers.tpl:
```yaml
{{- define "app-python.environment" -}}
- name: APP_ENV
  value: {{ .Values.environment | quote }}
- name: APP_PORT
  value: {{ .Values.service.port | quote }}
{{- end -}}
``` 